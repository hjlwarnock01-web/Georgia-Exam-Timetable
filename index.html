<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📚 My Exam Study Tracker - FIXED</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 968px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .timer-display {
            text-align: center;
            margin: 30px 0;
        }

        .timer-display .time {
            font-size: 4em;
            font-weight: bold;
            color: #667eea;
            font-family: 'Courier New', monospace;
        }

        .timer-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .subject-selector {
            margin: 20px 0;
        }

        .subject-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1em;
            background: white;
            cursor: pointer;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .subject-breakdown {
            margin-top: 20px;
        }

        .subject-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
            align-items: center;
        }

        .subject-item:last-child {
            border-bottom: none;
        }

        .subject-name {
            font-weight: 600;
        }

        .subject-time {
            color: #667eea;
            font-weight: 600;
        }

        .tip-content {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 20px;
            border-radius: 10px;
            font-size: 1.1em;
            line-height: 1.6;
            color: #555;
            font-style: italic;
        }

        .week-section {
            margin-bottom: 30px;
        }

        .week-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 1.2em;
        }

        .day-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .day-title {
            font-weight: 600;
            font-size: 1.1em;
            color: #2d3748;
        }

        .exam-badge {
            background: #f56565;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .rest-badge {
            background: #48bb78;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .session-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 50px;
            padding: 10px 5px;
            border-radius: 8px;
            transition: all 0.3s ease;
            border: 2px dashed transparent;
        }

        .session-list.drag-over {
            background: #e6f2ff !important;
            border: 2px dashed #667eea !important;
            transform: scale(1.02);
        }

        .session-list:empty::before {
            content: 'Drop sessions here';
            color: #cbd5e0;
            font-style: italic;
            text-align: center;
            display: block;
            padding: 10px;
        }

        .session-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: grab;
            transition: all 0.2s ease;
            position: relative;
        }

        .session-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .session-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .drag-handle {
            cursor: grab;
            color: #999;
            font-size: 1.2em;
            user-select: none;
        }

        .session-item.dragging .drag-handle {
            cursor: grabbing;
        }

        .session-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .session-content {
            flex: 1;
        }

        .session-subject {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 3px;
        }

        .session-topic {
            font-size: 0.9em;
            color: #718096;
        }

        .subject-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            white-space: nowrap;
        }

        .subject-Math { background: #fef5e7; color: #dc7633; }
        .subject-Physics { background: #ebf5fb; color: #2980b9; }
        .subject-Chemistry { background: #e8f8f5; color: #16a085; }
        .subject-Biology { background: #fdf2e9; color: #d68910; }
        .subject-History { background: #f4ecf7; color: #884ea0; }
        .subject-Geography { background: #f9ebea; color: #cb4335; }
        .subject-English { background: #eafaf1; color: #1e8449; }
        .subject-IT { background: #f0f3f4; color: #5d6d7e; }
        .subject-Mock { background: #ffebee; color: #c62828; }

        .progress-bar {
            background: #e2e8f0;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, #48bb78, #38a169);
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .pool-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .pool-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .pool-header h2 {
            color: #667eea;
            margin: 0;
        }

        .pool-count {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .pool-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .pool-item {
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: grab;
            transition: all 0.2s ease;
        }

        .pool-item:hover {
            background: #edf2f7;
            transform: translateX(5px);
        }

        .pool-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .pool-item-content {
            flex: 1;
        }

        .pool-actions {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s ease;
        }

        .action-btn-edit {
            background: #4299e1;
            color: white;
        }

        .action-btn-edit:hover {
            background: #3182ce;
        }

        .action-btn-delete {
            background: #fc8181;
            color: white;
        }

        .action-btn-delete:hover {
            background: #f56565;
        }

        .add-pool-btn {
            width: 100%;
            padding: 12px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.2s ease;
        }

        .add-pool-btn:hover {
            background: #38a169;
            transform: translateY(-2px);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
        }

        .modal-header {
            font-size: 1.5em;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .btn-modal {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-cancel {
            background: #e2e8f0;
            color: #2d3748;
        }

        .btn-cancel:hover {
            background: #cbd5e0;
        }

        .btn-save {
            background: #48bb78;
            color: white;
        }

        .btn-save:hover {
            background: #38a169;
        }

        .session-menu {
            position: absolute;
            right: 45px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 5px;
            display: none;
            z-index: 100;
            min-width: 120px;
        }

        .session-menu.show {
            display: block;
        }

        .session-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .session-menu-item:hover {
            background: #f7fafc;
        }

        .session-menu-item.edit {
            color: #4299e1;
        }

        .session-menu-item.delete {
            color: #f56565;
        }

        .menu-trigger {
            cursor: pointer;
            padding: 5px 10px;
            color: #999;
            font-size: 1.2em;
            user-select: none;
            position: relative;
        }

        .menu-trigger:hover {
            color: #667eea;
        }

        .debug-badge {
            background: #fbbf24;
            color: #78350f;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.75em;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>📚 My Exam Study Tracker</h1>
            <p class="subtitle">Track your study progress for upcoming exams <span class="debug-badge">DRAG FIX v2</span></p>
        </header>

        <!-- Pool Section - To Add Later -->
        <div class="pool-section">
            <div class="pool-header">
                <h2>📥 To Add Later</h2>
                <span class="pool-count" id="poolCount">0 sessions</span>
            </div>
            <div class="pool-items" id="poolItems">
                <!-- Pool items will be dynamically added here -->
            </div>
            <button class="add-pool-btn" onclick="openAddModal()">➕ Add New Session to Pool</button>
        </div>

        <div class="grid">
            <!-- Left Column - Timetable -->
            <div class="card">
                <h2>📅 Weekly Study Timetable</h2>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar">0%</div>
                </div>
                <div id="timetableContent">
                    <!-- Timetable will be loaded here -->
                </div>
            </div>

            <!-- Right Column - Timer & Stats -->
            <div>
                <!-- Study Timer -->
                <div class="card">
                    <h2>⏱️ Study Timer</h2>
                    <div class="subject-selector">
                        <select id="timerSubject">
                            <option value="">Select Subject</option>
                            <option value="Mathematics P1">Mathematics P1</option>
                            <option value="Mathematics P2">Mathematics P2</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Biology">Biology</option>
                            <option value="History">History</option>
                            <option value="Geography">Geography</option>
                            <option value="English">English</option>
                            <option value="IT">IT</option>
                        </select>
                    </div>
                    <div class="timer-display">
                        <div class="time" id="timerDisplay">00:00:00</div>
                    </div>
                    <div class="timer-controls">
                        <button class="btn btn-success" id="startBtn" onclick="startTimer()">Start</button>
                        <button class="btn btn-danger" id="pauseBtn" onclick="pauseTimer()" disabled>Pause</button>
                        <button class="btn btn-primary" id="resetBtn" onclick="resetTimer()">Reset</button>
                    </div>
                </div>

                <!-- Study Statistics -->
                <div class="card">
                    <h2>📊 Study Statistics</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalHours">0</div>
                            <div class="stat-label">Total Hours</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="sessionsCompleted">0</div>
                            <div class="stat-label">Sessions Done</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="daysLeft">0</div>
                            <div class="stat-label">Days to Exam</div>
                        </div>
                    </div>
                    <div class="subject-breakdown">
                        <h3 style="margin-bottom: 15px; color: #667eea;">By Subject</h3>
                        <div id="subjectStats">
                            <!-- Subject breakdown will be added here -->
                        </div>
                    </div>
                </div>

                <!-- Study Tips -->
                <div class="card">
                    <h2>💡 Study Tip of the Day</h2>
                    <div class="tip-content" id="studyTip">
                        Use active recall: Test yourself frequently instead of just re-reading notes. This strengthens memory retention!
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // TIMER FUNCTIONALITY
        let timerInterval = null;
        let seconds = 0;
        let isRunning = false;
        let studyLog = JSON.parse(localStorage.getItem('studyLog') || '{}');

        function updateTimerDisplay() {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            document.getElementById('timerDisplay').textContent = 
                `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function startTimer() {
            const subject = document.getElementById('timerSubject').value;
            if (!subject) {
                alert('Please select a subject first!');
                return;
            }
            
            isRunning = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            
            timerInterval = setInterval(() => {
                seconds++;
                updateTimerDisplay();
            }, 1000);
        }

        function pauseTimer() {
            isRunning = false;
            clearInterval(timerInterval);
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            
            const subject = document.getElementById('timerSubject').value;
            if (subject && seconds > 0) {
                if (!studyLog[subject]) {
                    studyLog[subject] = 0;
                }
                studyLog[subject] += seconds;
                localStorage.setItem('studyLog', JSON.stringify(studyLog));
                updateStatistics();
            }
        }

        function resetTimer() {
            clearInterval(timerInterval);
            seconds = 0;
            isRunning = false;
            updateTimerDisplay();
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
        }

        function updateStatistics() {
            let totalSeconds = 0;
            for (let subject in studyLog) {
                totalSeconds += studyLog[subject];
            }
            
            const totalHours = (totalSeconds / 3600).toFixed(1);
            document.getElementById('totalHours').textContent = totalHours;
            
            const sessionsCompleted = countCompletedSessions();
            document.getElementById('sessionsCompleted').textContent = sessionsCompleted;
            
            const firstExamDate = new Date('2024-11-04');
            const today = new Date();
            const daysLeft = Math.ceil((firstExamDate - today) / (1000 * 60 * 60 * 24));
            document.getElementById('daysLeft').textContent = Math.max(0, daysLeft);
            
            const subjectStatsDiv = document.getElementById('subjectStats');
            subjectStatsDiv.innerHTML = '';
            
            const sortedSubjects = Object.entries(studyLog).sort((a, b) => b[1] - a[1]);
            
            sortedSubjects.forEach(([subject, seconds]) => {
                const hours = (seconds / 3600).toFixed(1);
                const div = document.createElement('div');
                div.className = 'subject-item';
                div.innerHTML = `
                    <span class="subject-name">${subject}</span>
                    <span class="subject-time">${hours}h</span>
                `;
                subjectStatsDiv.appendChild(div);
            });
        }

        function countCompletedSessions() {
            let count = 0;
            for (let week in timetableData) {
                for (let day of timetableData[week]) {
                    if (day.sessions) {
                        count += day.sessions.filter(s => s.completed).length;
                    }
                }
            }
            return count;
        }

        // TIMETABLE DATA
        let timetableData = {
            "Week 1": [
                {
                    date: "SAT Oct 26",
                    sessions: [
                        { id: "satoct26-1", subject: "Mathematics P2", topic: "Calculus", completed: false },
                        { id: "satoct26-2", subject: "Physics", topic: "Mechanics", completed: false },
                        { id: "satoct26-3", subject: "Chemistry", topic: "Organic Chemistry", completed: false }
                    ]
                },
                {
                    date: "SUN Oct 27",
                    sessions: [
                        { id: "sunoct27-1", subject: "Biology", topic: "Cell Biology", completed: false },
                        { id: "sunoct27-2", subject: "Mathematics P1", topic: "Algebra", completed: false },
                        { id: "sunoct27-3", subject: "History", topic: "WWI", completed: false }
                    ]
                },
                {
                    date: "MON Oct 28",
                    sessions: [
                        { id: "monoct28-1", subject: "Geography", topic: "Climate Change", completed: false },
                        { id: "monoct28-2", subject: "English", topic: "Poetry Analysis", completed: false }
                    ]
                },
                {
                    date: "TUE Oct 29",
                    sessions: [
                        { id: "tueoct29-1", subject: "IT", topic: "Programming Basics", completed: false },
                        { id: "tueoct29-2", subject: "Mathematics P2", topic: "Statistics", completed: false }
                    ]
                },
                {
                    date: "WED Oct 30",
                    sessions: [
                        { id: "wedoct30-1", subject: "Physics", topic: "Electricity", completed: false },
                        { id: "wedoct30-2", subject: "Chemistry", topic: "Inorganic Chemistry", completed: false }
                    ]
                },
                {
                    date: "THU Oct 31",
                    sessions: [
                        { id: "thuoct31-1", subject: "Biology", topic: "Genetics", completed: false },
                        { id: "thuoct31-2", subject: "History", topic: "WWII", completed: false }
                    ]
                },
                {
                    date: "FRI Nov 01",
                    sessions: [
                        { id: "frinov01-1", subject: "Mathematics P1", topic: "Trigonometry", completed: false },
                        { id: "frinov01-2", subject: "Geography", topic: "Urban Geography", completed: false }
                    ]
                }
            ],
            "Week 2": [
                {
                    date: "SAT Nov 02",
                    sessions: [
                        { id: "satnov02-1", subject: "English", topic: "Essay Writing", completed: false },
                        { id: "satnov02-2", subject: "IT", topic: "Data Structures", completed: false }
                    ]
                },
                {
                    date: "SUN Nov 03",
                    sessions: [
                        { id: "sunnov03-1", subject: "Mathematics P2", topic: "Integration", completed: false },
                        { id: "sunnov03-2", subject: "Mock Exam", topic: "Math P2 Practice", completed: false }
                    ]
                },
                {
                    date: "MON Nov 04",
                    exam: "Mathematics P2"
                },
                {
                    date: "TUE Nov 05",
                    sessions: [
                        { id: "tuenov05-1", subject: "Physics", topic: "Thermodynamics", completed: false },
                        { id: "tuenov05-2", subject: "Chemistry", topic: "Chemical Reactions", completed: false }
                    ]
                },
                {
                    date: "WED Nov 06",
                    sessions: [
                        { id: "wednov06-1", subject: "Biology", topic: "Ecology", completed: false },
                        { id: "wednov06-2", subject: "Mock Exam", topic: "Physics Practice", completed: false }
                    ]
                },
                {
                    date: "THU Nov 07",
                    exam: "Physics"
                },
                {
                    date: "FRI Nov 08",
                    sessions: [
                        { id: "frinov08-1", subject: "Chemistry", topic: "Equilibrium", completed: false },
                        { id: "frinov08-2", subject: "History", topic: "Cold War", completed: false }
                    ]
                }
            ],
            "Week 3": [
                {
                    date: "SAT Nov 09",
                    sessions: [
                        { id: "satnov09-1", subject: "Mock Exam", topic: "Chemistry Practice", completed: false }
                    ]
                },
                {
                    date: "SUN Nov 10",
                    rest: true
                },
                {
                    date: "MON Nov 11",
                    exam: "Chemistry"
                },
                {
                    date: "TUE Nov 12",
                    sessions: [
                        { id: "tuenov12-1", subject: "Biology", topic: "Evolution", completed: false },
                        { id: "tuenov12-2", subject: "Mathematics P1", topic: "Geometry", completed: false }
                    ]
                },
                {
                    date: "WED Nov 13",
                    sessions: [
                        { id: "wednov13-1", subject: "Mock Exam", topic: "Biology Practice", completed: false }
                    ]
                },
                {
                    date: "THU Nov 14",
                    exam: "Biology"
                },
                {
                    date: "FRI Nov 15",
                    sessions: [
                        { id: "frinov15-1", subject: "Geography", topic: "Economic Geography", completed: false },
                        { id: "frinov15-2", subject: "English", topic: "Shakespeare", completed: false }
                    ]
                }
            ],
            "Week 4": [
                {
                    date: "SAT Nov 16",
                    sessions: [
                        { id: "satnov16-1", subject: "Mock Exam", topic: "Math P1 Practice", completed: false }
                    ]
                },
                {
                    date: "SUN Nov 17",
                    rest: true
                },
                {
                    date: "MON Nov 18",
                    exam: "Mathematics P1"
                },
                {
                    date: "TUE Nov 19",
                    sessions: [
                        { id: "tuenov19-1", subject: "History", topic: "Modern History", completed: false },
                        { id: "tuenov19-2", subject: "Geography", topic: "Physical Geography", completed: false }
                    ]
                },
                {
                    date: "WED Nov 20",
                    sessions: [
                        { id: "wednov20-1", subject: "Mock Exam", topic: "History Practice", completed: false }
                    ]
                },
                {
                    date: "THU Nov 21",
                    exam: "History"
                },
                {
                    date: "FRI Nov 22",
                    sessions: [
                        { id: "frinov22-1", subject: "English", topic: "Novel Study", completed: false },
                        { id: "frinov22-2", subject: "IT", topic: "Algorithms", completed: false }
                    ]
                }
            ],
            "Week 5": [
                {
                    date: "SAT Nov 23",
                    sessions: [
                        { id: "satnov23-1", subject: "Mock Exam", topic: "Geography Practice", completed: false }
                    ]
                },
                {
                    date: "SUN Nov 24",
                    rest: true
                },
                {
                    date: "MON Nov 25",
                    exam: "Geography"
                },
                {
                    date: "TUE Nov 26",
                    sessions: [
                        { id: "tuenov26-1", subject: "English", topic: "Exam Technique", completed: false },
                        { id: "tuenov26-2", subject: "IT", topic: "Review", completed: false }
                    ]
                },
                {
                    date: "WED Nov 27",
                    sessions: [
                        { id: "wednov27-1", subject: "Mock Exam", topic: "English Practice", completed: false }
                    ]
                },
                {
                    date: "THU Nov 28",
                    exam: "English"
                },
                {
                    date: "FRI Nov 29",
                    sessions: [
                        { id: "frinov29-1", subject: "Mock Exam", topic: "IT Practice", completed: false }
                    ]
                }
            ]
        };

        // Load from localStorage if available
        const savedData = localStorage.getItem('timetableData');
        if (savedData) {
            timetableData = JSON.parse(savedData);
        } else {
            localStorage.setItem('timetableData', JSON.stringify(timetableData));
        }

        // POOL DATA
        let poolData = [
            { subject: "Mathematics P2", topic: "Differentiation Rules" },
            { subject: "Mathematics P2", topic: "Integration Techniques" },
            { subject: "Mathematics P2", topic: "Differential Equations" },
            { subject: "Mathematics P2", topic: "Parametric Equations" },
            { subject: "Mathematics P2", topic: "Sequences and Series" },
            { subject: "Physics", topic: "Kinematics" },
            { subject: "Physics", topic: "Dynamics" },
            { subject: "Physics", topic: "Circular Motion" },
            { subject: "Physics", topic: "Electromagnetism" },
            { subject: "Physics", topic: "Waves and Sound" },
            { subject: "Physics", topic: "Quantum Physics" },
            { subject: "Chemistry", topic: "Thermochemistry" },
            { subject: "Chemistry", topic: "Electrochemistry" },
            { subject: "Chemistry", topic: "Chemical Kinetics" },
            { subject: "Chemistry", topic: "Acids and Bases" },
            { subject: "Chemistry", topic: "Redox Reactions" },
            { subject: "Biology", topic: "Photosynthesis" },
            { subject: "Biology", topic: "Respiration" },
            { subject: "Biology", topic: "DNA Structure" },
            { subject: "Biology", topic: "Protein Synthesis" },
            { subject: "Biology", topic: "Inheritance Patterns" },
            { subject: "Biology", topic: "Natural Selection" },
            { subject: "Mathematics P1", topic: "Quadratic Functions" },
            { subject: "Mathematics P1", topic: "Exponential Functions" },
            { subject: "Mathematics P1", topic: "Logarithms" },
            { subject: "Mathematics P1", topic: "Sequences" },
            { subject: "Mathematics P1", topic: "Circle Theorems" },
            { subject: "Mathematics P1", topic: "Coordinate Geometry" },
            { subject: "History", topic: "Treaty of Versailles" },
            { subject: "History", topic: "Rise of Fascism" },
            { subject: "History", topic: "Pearl Harbor" },
            { subject: "History", topic: "D-Day" },
            { subject: "History", topic: "Cuban Missile Crisis" },
            { subject: "History", topic: "Fall of Berlin Wall" },
            { subject: "Geography", topic: "Greenhouse Effect" },
            { subject: "Geography", topic: "Deforestation" },
            { subject: "Geography", topic: "Urbanization" },
            { subject: "Geography", topic: "Migration Patterns" },
            { subject: "Geography", topic: "Resource Management" },
            { subject: "Geography", topic: "Tectonic Plates" },
            { subject: "English", topic: "Metaphor and Simile" },
            { subject: "English", topic: "Sonnet Analysis" },
            { subject: "English", topic: "Persuasive Writing" },
            { subject: "English", topic: "Character Development" },
            { subject: "English", topic: "Theme Analysis" },
            { subject: "English", topic: "Literary Devices" },
            { subject: "IT", topic: "Variables and Data Types" },
            { subject: "IT", topic: "Control Structures" },
            { subject: "IT", topic: "Functions" },
            { subject: "IT", topic: "Arrays" },
            { subject: "IT", topic: "Sorting Algorithms" },
            { subject: "IT", topic: "Binary Search" },
            { subject: "Mock Exam", topic: "Full Math P2 Paper" },
            { subject: "Mock Exam", topic: "Full Physics Paper" },
            { subject: "Mock Exam", topic: "Full Chemistry Paper" },
            { subject: "Mock Exam", topic: "Full Biology Paper" }
        ];

        // Load pool data from localStorage
        const savedPool = localStorage.getItem('poolData');
        if (savedPool) {
            poolData = JSON.parse(savedPool);
        } else {
            localStorage.setItem('poolData', JSON.stringify(poolData));
        }

        function initializePool() {
            renderPool();
            loadTimetable();
            updateStatistics();
            updateProgress();
        }

        function renderPool() {
            const poolContainer = document.getElementById('poolItems');
            const poolCount = document.getElementById('poolCount');
            
            poolCount.textContent = `${poolData.length} session${poolData.length !== 1 ? 's' : ''}`;
            
            poolContainer.innerHTML = '';
            
            poolData.forEach((item, index) => {
                const poolItem = document.createElement('div');
                poolItem.className = 'pool-item';
                poolItem.draggable = true;
                poolItem.dataset.index = index;
                poolItem.dataset.subject = item.subject;
                poolItem.dataset.topic = item.topic;
                
                poolItem.innerHTML = `
                    <span class="drag-handle">⋮⋮</span>
                    <div class="pool-item-content">
                        <div class="session-subject">${item.subject}</div>
                        <div class="session-topic">${item.topic}</div>
                    </div>
                    <div class="pool-actions">
                        <button class="action-btn action-btn-edit" onclick="editPoolItem(${index})">✏️</button>
                        <button class="action-btn action-btn-delete" onclick="deletePoolItem(${index})">🗑️</button>
                    </div>
                `;
                
                poolItem.addEventListener('dragstart', handlePoolDragStart);
                poolItem.addEventListener('dragend', handleDragEnd);
                
                poolContainer.appendChild(poolItem);
            });
        }

        // TIMETABLE RENDERING
        function loadTimetable() {
            const container = document.getElementById('timetableContent');
            container.innerHTML = '';

            for (const [weekName, days] of Object.entries(timetableData)) {
                const weekSection = document.createElement('div');
                weekSection.className = 'week-section';
                
                const weekHeader = document.createElement('div');
                weekHeader.className = 'week-header';
                weekHeader.textContent = weekName;
                weekSection.appendChild(weekHeader);

                days.forEach(day => {
                    const dayCard = document.createElement('div');
                    dayCard.className = 'day-card';
                    
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    
                    const dayTitle = document.createElement('div');
                    dayTitle.className = 'day-title';
                    dayTitle.textContent = day.date;
                    dayHeader.appendChild(dayTitle);
                    
                    if (day.exam) {
                        const examBadge = document.createElement('span');
                        examBadge.className = 'exam-badge';
                        examBadge.textContent = `🎓 EXAM: ${day.exam}`;
                        dayHeader.appendChild(examBadge);
                    } else if (day.rest) {
                        const restBadge = document.createElement('span');
                        restBadge.className = 'rest-badge';
                        restBadge.textContent = '😴 Rest Day';
                        dayHeader.appendChild(restBadge);
                    }
                    
                    dayCard.appendChild(dayHeader);
                    
                    // CRITICAL FIX: Create session list for ALL days (including exam/rest days)
                    const sessionList = document.createElement('div');
                    sessionList.className = 'session-list';
                    sessionList.dataset.dayDate = day.date; // Store date on the list itself
                    sessionList.addEventListener('dragover', handleDragOver);
                    sessionList.addEventListener('dragenter', handleDragEnter);
                    sessionList.addEventListener('dragleave', handleDragLeave);
                    sessionList.addEventListener('drop', handleDrop);
                    
                    if (day.sessions && day.sessions.length > 0) {
                        day.sessions.forEach(session => {
                            const sessionItem = document.createElement('div');
                            sessionItem.className = 'session-item';
                            sessionItem.draggable = true;
                            sessionItem.dataset.sessionId = session.id;
                            
                            const subjectClass = session.subject.split(' ')[0];
                            
                            sessionItem.innerHTML = `
                                <span class="drag-handle">⋮⋮</span>
                                <input type="checkbox" ${session.completed ? 'checked' : ''} 
                                       onchange="toggleComplete('${session.id}')">
                                <div class="session-content">
                                    <div class="session-subject">${session.subject}</div>
                                    <div class="session-topic">${session.topic}</div>
                                </div>
                                <span class="subject-badge subject-${subjectClass}">${subjectClass}</span>
                                <span class="menu-trigger" onclick="toggleSessionMenu(this.parentElement)">⋮</span>
                                <div class="session-menu">
                                    <div class="session-menu-item edit" onclick="editSession('${session.id}')">
                                        ✏️ Edit
                                    </div>
                                    <div class="session-menu-item delete" onclick="deleteSession('${session.id}')">
                                        🗑️ Delete
                                    </div>
                                </div>
                            `;
                            
                            sessionItem.addEventListener('dragstart', handleSessionDragStart);
                            sessionItem.addEventListener('dragend', handleDragEnd);
                            
                            sessionList.appendChild(sessionItem);
                        });
                    }
                    
                    // Always append the session list, even if empty
                    dayCard.appendChild(sessionList);
                    weekSection.appendChild(dayCard);
                });

                container.appendChild(weekSection);
            }
            
            updateProgress();
        }

        function toggleComplete(sessionId) {
            for (const week in timetableData) {
                for (const day of timetableData[week]) {
                    if (day.sessions) {
                        const session = day.sessions.find(s => s.id === sessionId);
                        if (session) {
                            session.completed = !session.completed;
                            localStorage.setItem('timetableData', JSON.stringify(timetableData));
                            updateProgress();
                            updateStatistics();
                            return;
                        }
                    }
                }
            }
        }

        function updateProgress() {
            let total = 0;
            let completed = 0;
            
            for (const week in timetableData) {
                for (const day of timetableData[week]) {
                    if (day.sessions) {
                        total += day.sessions.length;
                        completed += day.sessions.filter(s => s.completed).length;
                    }
                }
            }
            
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';
        }

        function updateTimetableData() {
            for (const week in timetableData) {
                for (const day of timetableData[week]) {
                    if (day.sessions) {
                        const dayTitle = day.date;
                        const dayCard = Array.from(document.querySelectorAll('.day-card')).find(card => {
                            return card.querySelector('.day-title').textContent === dayTitle;
                        });
                        
                        if (dayCard) {
                            const sessionList = dayCard.querySelector('.session-list');
                            if (sessionList) {
                                const sessionItems = Array.from(sessionList.querySelectorAll('.session-item'));
                                day.sessions = sessionItems.map(item => {
                                    const sessionId = item.dataset.sessionId;
                                    return day.sessions.find(s => s.id === sessionId);
                                }).filter(Boolean);
                            }
                        }
                    }
                }
            }
            
            localStorage.setItem('timetableData', JSON.stringify(timetableData));
        }

        // POOL MODAL FUNCTIONS
        function openAddModal() {
            document.getElementById('addSessionModal').style.display = 'block';
            document.getElementById('newSubject').value = '';
            document.getElementById('newTopic').value = '';
        }

        function closeAddModal() {
            document.getElementById('addSessionModal').style.display = 'none';
        }

        function saveNewSession() {
            const subject = document.getElementById('newSubject').value.trim();
            const topic = document.getElementById('newTopic').value.trim();
            
            if (!subject || !topic) {
                alert('Please fill in both subject and topic');
                return;
            }
            
            poolData.push({ subject, topic });
            localStorage.setItem('poolData', JSON.stringify(poolData));
            renderPool();
            closeAddModal();
        }

        function editPoolItem(index) {
            const item = poolData[index];
            if (!item) return;
            
            const newSubject = prompt('Edit Subject:', item.subject);
            if (newSubject === null) return;
            
            const newTopic = prompt('Edit Topic:', item.topic);
            if (newTopic === null) return;
            
            if (newSubject.trim() && newTopic.trim()) {
                poolData[index] = { subject: newSubject.trim(), topic: newTopic.trim() };
                localStorage.setItem('poolData', JSON.stringify(poolData));
                renderPool();
            }
        }

        function deletePoolItem(index) {
            if (confirm('Delete this session from the pool?')) {
                poolData.splice(index, 1);
                localStorage.setItem('poolData', JSON.stringify(poolData));
                renderPool();
            }
        }

        // DRAG AND DROP - IMPROVED
        let draggedElement = null;
        let dragSource = null;

        function handlePoolDragStart(e) {
            draggedElement = this;
            dragSource = 'pool';
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', '');
            console.log('Started dragging from pool:', this.dataset.subject, this.dataset.topic);
        }

        function handleDragEnd(e) {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
            }
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
            console.log('Drag ended');
            draggedElement = null;
            dragSource = null;
        }

        function handleSessionDragStart(e) {
            draggedElement = this;
            dragSource = 'timetable';
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', '');
            console.log('Started dragging session from timetable:', this.dataset.sessionId);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            
            const dropTarget = e.target.closest('.session-list');
            if (dropTarget) {
                dropTarget.classList.add('drag-over');
            }
            
            return false;
        }

        function handleDragEnter(e) {
            const dropTarget = e.target.closest('.session-list');
            if (dropTarget) {
                dropTarget.classList.add('drag-over');
                console.log('Drag entered:', dropTarget.dataset.dayDate);
            }
        }

        function handleDragLeave(e) {
            const dropTarget = e.target.closest('.session-list');
            if (dropTarget && !dropTarget.contains(e.relatedTarget)) {
                dropTarget.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            e.preventDefault();
            
            const dropTarget = e.target.closest('.session-list');
            if (!dropTarget) {
                console.error('No drop target found');
                return false;
            }
            
            dropTarget.classList.remove('drag-over');
            
            if (!draggedElement) {
                console.error('No dragged element');
                return false;
            }
            
            // Get the date from the session-list itself
            const dayDate = dropTarget.dataset.dayDate;
            console.log('Dropping on date:', dayDate);
            
            if (dragSource === 'pool') {
                const index = parseInt(draggedElement.dataset.index);
                const subject = draggedElement.dataset.subject;
                const topic = draggedElement.dataset.topic;
                
                console.log('Adding session from pool:', subject, topic, 'to', dayDate);
                
                addSessionToDay(dayDate, subject, topic);
                
                // Remove from pool
                poolData.splice(index, 1);
                localStorage.setItem('poolData', JSON.stringify(poolData));
                renderPool();
                
            } else if (dragSource === 'timetable') {
                if (draggedElement.parentNode !== dropTarget) {
                    console.log('Moving session between days');
                    dropTarget.appendChild(draggedElement);
                    updateTimetableData();
                }
            }
            
            return false;
        }

        function addSessionToDay(dayDate, subject, topic) {
            console.log('🔍 Attempting to add session to:', dayDate);
            console.log('📚 Session details:', subject, '-', topic);
            
            let found = false;
            
            for (const week in timetableData) {
                for (const day of timetableData[week]) {
                    // Trim both dates for comparison
                    const normalizedDayDate = day.date.trim();
                    const normalizedDropDate = dayDate.trim();
                    
                    console.log('  Comparing:', normalizedDayDate, '===', normalizedDropDate);
                    
                    if (normalizedDayDate === normalizedDropDate) {
                        found = true;
                        console.log('✅ Found matching day!');
                        
                        // Initialize sessions array if it doesn't exist
                        if (!day.sessions) {
                            day.sessions = [];
                            console.log('  Created new sessions array');
                        }
                        
                        const timestamp = Date.now();
                        const sessionId = dayDate.toLowerCase().replace(/\s/g, '') + '-' + timestamp;
                        
                        day.sessions.push({
                            id: sessionId,
                            subject: subject,
                            topic: topic,
                            completed: false
                        });
                        
                        console.log('  Session added! Total sessions now:', day.sessions.length);
                        
                        localStorage.setItem('timetableData', JSON.stringify(timetableData));
                        loadTimetable();
                        return;
                    }
                }
            }
            
            if (!found) {
                console.error('❌ Could not find date in timetable:', dayDate);
                console.log('Available dates:');
                for (const week in timetableData) {
                    for (const day of timetableData[week]) {
                        console.log('  -', day.date);
                    }
                }
                alert('Error: Could not add session to "' + dayDate + '". This date may not exist in the timetable. Check the console for details.');
            }
        }

        // SESSION MENU FUNCTIONS
        function toggleSessionMenu(sessionItem) {
            document.querySelectorAll('.session-menu.show').forEach(menu => {
                if (menu !== sessionItem.querySelector('.session-menu')) {
                    menu.classList.remove('show');
                }
            });
            
            const menu = sessionItem.querySelector('.session-menu');
            if (menu) {
                menu.classList.toggle('show');
            }
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.session-item') && !e.target.closest('.session-menu')) {
                document.querySelectorAll('.session-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
            
            const poolModal = document.getElementById('addSessionModal');
            if (e.target === poolModal) {
                closeAddModal();
            }
        });

        function editSession(sessionId) {
            document.querySelectorAll('.session-menu.show').forEach(menu => {
                menu.classList.remove('show');
            });
            
            let foundSession = null;
            
            for (const week in timetableData) {
                for (const day of timetableData[week]) {
                    if (day.sessions) {
                        const session = day.sessions.find(s => s.id === sessionId);
                        if (session) {
                            foundSession = session;
                            break;
                        }
                    }
                }
                if (foundSession) break;
            }
            
            if (!foundSession) {
                alert('Session not found');
                return;
            }
            
            const newSubject = prompt('Edit Subject:', foundSession.subject);
            if (newSubject === null) return;
            
            const newTopic = prompt('Edit Topic:', foundSession.topic);
            if (newTopic === null) return;
            
            if (newSubject.trim() && newTopic.trim()) {
                foundSession.subject = newSubject.trim();
                foundSession.topic = newTopic.trim();
                localStorage.setItem('timetableData', JSON.stringify(timetableData));
                loadTimetable();
            }
        }

        function deleteSession(sessionId) {
            document.querySelectorAll('.session-menu.show').forEach(menu => {
                menu.classList.remove('show');
            });
            
            if (!confirm('Delete this session from your timetable?')) {
                return;
            }
            
            for (const week in timetableData) {
                for (const day of timetableData[week]) {
                    if (day.sessions) {
                        const index = day.sessions.findIndex(s => s.id === sessionId);
                        if (index !== -1) {
                            day.sessions.splice(index, 1);
                            localStorage.setItem('timetableData', JSON.stringify(timetableData));
                            loadTimetable();
                            return;
                        }
                    }
                }
            }
            
            alert('Session not found');
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', function() {
            initializePool();
            console.log('🚀 Tracker initialized!');
            console.log('Available dates in timetable:');
            for (const week in timetableData) {
                console.log('Week:', week);
                for (const day of timetableData[week]) {
                    console.log('  -', day.date);
                }
            }
        });

    </script>

    <!-- Add Session Modal -->
    <div id="addSessionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">➕ Add New Session</div>
            <div class="form-group">
                <label for="newSubject">Subject:</label>
                <input type="text" id="newSubject" placeholder="e.g., Mathematics P2">
            </div>
            <div class="form-group">
                <label for="newTopic">Topic:</label>
                <input type="text" id="newTopic" placeholder="e.g., Trigonometry">
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-cancel" onclick="closeAddModal()">Cancel</button>
                <button class="btn-modal btn-save" onclick="saveNewSession()">Add to Pool</button>
            </div>
        </div>
    </div>

</body>
</html>
